{% extends "base.html" %}
{% load crispy_forms_tags %}
{% load listings_tags %}

{% block content %}
<main class="container">
    <div class="row">
        <aside class="col-lg-3">
            <form id="filter-form" class="mb-4 p-3 bg-light rounded" action="{% url 'listings:listing_list' %}" method="get">
                {% csrf_token %}
                {% comment %}
                  FIX: Instead of rendering the whole form, we render each field
                  individually to explicitly exclude the 'q' (search) field.
                {% endcomment %}
                {{ filter.form.category|as_crispy_field }}
                {{ filter.form.city|as_crispy_field }}

                <button type="submit" class="btn btn-primary w-100 mt-3">Apply</button>
            </form>
        </aside>

        <section class="col-lg-9">
             <h2 class="mb-3">Find Deals</h2>
            <div id="listings-container" class="row row-cols-1 row-cols-md-2 row-cols-lg-3 g-4">
                {% include 'listings/partials/listings_grid.html' with listings=listings %}
            </div>
        </section>
    </div>
</main>
{% endblock %}

{% block extra_js %}
<script>
document.addEventListener('DOMContentLoaded', function() {
    const listingsContainer = document.getElementById('listings-container');

    listingsContainer.addEventListener('click', function(event) {
        const saveButton = event.target.closest('.save-button');
        if (saveButton) {
            event.preventDefault();
            const url = saveButton.dataset.url;

            fetch(url, {
                method: 'POST',
                headers: {
                    'X-CSRFToken': csrftoken,
                    'Content-Type': 'application/json'
                }
            })
            .then(response => response.json())
            .then(data => {
                const icon = saveButton.querySelector('i');
                if (data.is_saved) {
                    icon.classList.remove('far');
                    icon.classList.add('fas', 'text-danger');
                } else {
                    icon.classList.remove('fas', 'text-danger');
                    icon.classList.add('far');
                }
            })
            .catch(error => console.error('Error:', error));
        }
    });
});
</script>
{% endblock %}