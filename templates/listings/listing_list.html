{% extends "base.html" %}
{% load crispy_forms_tags %}
{% load listings_tags %}

{% block content %}
<div class="row">
    <aside class="col-lg-2">
        <div class="filter-sidebar">
            <h4 class="mb-3">Filters</h4>
            <form id="filter-form">
                {{ filter.form|crispy }}
            </form>
        </div>
    </aside>

    <main class="col-lg-10">
        <h2 class="mb-3">Today's Picks</h2>
        <div id="listings-container" class="row row-cols-2 row-cols-md-4 row-cols-lg-5 g-2">
            {% include 'listings/partials/listings_grid.html' %}
        </div>
    </main>
</div>
{% endblock %}

{% block extra_js %}
<script>
    document.addEventListener('DOMContentLoaded', function() {
        const filterForm = document.getElementById('filter-form');
        const listingsContainer = document.getElementById('listings-container');

        function updateListings() {
            const formData = new FormData(filterForm);
            const params = new URLSearchParams(formData);

            fetch(`/api/filter-listings/?${params.toString()}`)
                .then(response => response.json())
                .then(data => {
                    listingsContainer.innerHTML = data.html;
                })
                .catch(error => console.error('Error fetching listings:', error));
        }

        filterForm.addEventListener('change', updateListings);
        filterForm.addEventListener('keyup', updateListings);

        listingsContainer.addEventListener('click', function(event) {
            const saveButton = event.target.closest('.save-button');
            if (saveButton) {
                const listingId = saveButton.dataset.listingId;
                const url = `/listing/${listingId}/save/`;
                const csrftoken = getCookie('csrftoken');

                fetch(url, {
                    method: 'POST',
                    headers: {
                        'X-CSRFToken': csrftoken,
                        'Content-Type': 'application/json'
                    }
                })
                .then(response => response.json())
                .then(data => {
                    const icon = saveButton.querySelector('i');
                    if (data.is_saved) {
                        icon.classList.remove('far');
                        icon.classList.add('fas', 'text-danger');
                    } else {
                        icon.classList.remove('fas', 'text-danger');
                        icon.classList.add('far');
                    }
                })
                .catch(error => console.error('Error:', error));
            }
        });

        function getCookie(name) {
            let cookieValue = null;
            if (document.cookie && document.cookie !== '') {
                const cookies = document.cookie.split(';');
                for (let i = 0; i < cookies.length; i++) {
                    const cookie = cookies[i].trim();
                    if (cookie.substring(0, name.length + 1) === (name + '=')) {
                        cookieValue = decodeURIComponent(cookie.substring(name.length + 1));
                        break;
                    }
                }
            }
            return cookieValue;
        }
    });
</script>
{% endblock %}