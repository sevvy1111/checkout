{% extends "base.html" %}
{% load crispy_forms_tags %}
{% load listings_tags %}

{% block content %}
<main class="col-lg-12">
    <h2 class="mb-3">Today's Picks</h2>
    <form id="filter-form" class="mb-4 p-3 bg-light rounded">
        {{ filter.form|crispy }}
    </form>

    <div id="listings-container" class="row row-cols-2 row-cols-md-3 row-cols-lg-4 g-4">
        {% include 'listings/partials/listings_grid.html' %}
    </div>
</main>
{% endblock %}

{% block extra_js %}
<script>
document.addEventListener('DOMContentLoaded', function() {
    const filterForm = document.getElementById('filter-form');
    const listingsContainer = document.getElementById('listings-container');

    function updateListings() {
        const formData = new FormData(filterForm);
        const params = new URLSearchParams(formData);
        const url = `{% url 'listings_api:filter_listings' %}?${params.toString()}`;

        history.pushState(null, '', `{% url 'listings:listing_list' %}?${params.toString()}`);

        fetch(url)
            .then(response => response.json())
            .then(data => {
                listingsContainer.innerHTML = data.html;
            })
            .catch(error => console.error('Error fetching listings:', error));
    }

    if (filterForm) {
        filterForm.addEventListener('input', updateListings);
    }

    // This event listener now works correctly because the button has a 'data-url'
    listingsContainer.addEventListener('click', function(event) {
        const saveButton = event.target.closest('.save-button');
        if (saveButton) {
            event.preventDefault();
            const url = saveButton.dataset.url; // This will no longer be 'undefined'

            fetch(url, {
                method: 'POST',
                headers: {
                    'X-CSRFToken': csrftoken, // from base.html
                    'Content-Type': 'application/json'
                }
            })
            .then(response => {
                if (!response.ok) throw new Error('Network response was not ok.');
                return response.json();
            })
            .then(data => {
                const icon = saveButton.querySelector('i');
                if (data.is_saved) {
                    icon.classList.remove('far');
                    icon.classList.add('fas', 'text-danger');
                } else {
                    icon.classList.remove('fas', 'text-danger');
                    icon.classList.add('far');
                }
            })
            .catch(error => console.error('Error:', error));
        }
    });
});
</script>
{% endblock %}