{% extends "base.html" %}
{% load crispy_forms_tags %}
{% load listings_tags %}

{% block main_container_classes %}container page-content my-4{% endblock %}

{% block content %}
<div class="row">
    <aside class="col-lg-3">
        <div class="filter-sidebar card p-3">
            <h5 class="d-flex justify-content-between align-items-center mb-3">
                <span>Filters</span>
                <button class="btn btn-link d-lg-none" type="button" data-bs-toggle="collapse" data-bs-target="#filter-collapse" aria-expanded="true" aria-controls="filter-collapse">
                    <i class="fas fa-filter"></i>
                </button>
            </h5>
            <div class="collapse show d-lg-block filter-collapse-mobile" id="filter-collapse">
                <form id="filter-form" method="get">
                    {{ filter.form.category|as_crispy_field }}
                    {{ filter.form.city|as_crispy_field }}
                    <button type="submit" class="btn btn-primary w-100 mt-3">Apply Filters</button>
                </form>
            </div>
        </div>
    </aside>

    <section class="col-lg-9">
        <h2 class="mb-3">{{ page_title }}</h2>
        <div id="listings-container" class="listing-grid">
            {% include 'listings/partials/listings_grid.html' with listings=listings %}
        </div>
    </section>
</div>
{% endblock %}

{% block extra_js %}
<script>
document.addEventListener('DOMContentLoaded', function() {
    const listingsContainer = document.getElementById('listings-container');

    listingsContainer.addEventListener('click', function(event) {
        const saveButton = event.target.closest('.save-button');
        if (saveButton) {
            event.preventDefault();
            const url = saveButton.dataset.url;

            fetch(url, {
                method: 'POST',
                headers: {
                    'X-CSRFToken': csrftoken,
                    'Content-Type': 'application/json'
                }
            })
            .then(response => {
                if (!response.ok) {
                    throw new Error('Network response was not ok');
                }
                return response.json();
            })
            .then(data => {
                const icon = saveButton.querySelector('i');
                if (data.is_saved) {
                    icon.classList.remove('far');
                    icon.classList.add('fas', 'text-danger');
                } else {
                    icon.classList.remove('fas', 'text-danger');
                    icon.classList.add('far');
                }
            })
            .catch(error => console.error('Error:', error));
        }
    });
});
</script>

<style>
@media (max-width: 991.98px) {
    .filter-collapse-mobile.collapsing {
        height: auto !important;
        transition: none !important;
    }

    .filter-collapse-mobile.collapse:not(.show) {
        display: none !important;
    }
}
</style>
{% endblock %}